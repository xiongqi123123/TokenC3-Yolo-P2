# TokenC3-LSNet æ™ºèƒ½å‰ªææ–¹æ¡ˆ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

TokenC3-LSNetå‰ªææ–¹æ¡ˆæ˜¯é’ˆå¯¹YOLOv13-TokenC3-LSNetæ¨¡å‹çš„è½»é‡åŒ–ä¼˜åŒ–è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡æ™ºèƒ½æƒé‡ç¨€ç–åŒ–æŠ€æœ¯å®ç°æ¨¡å‹å‹ç¼©ï¼Œåœ¨ä¿æŒæ£€æµ‹ç²¾åº¦çš„å‰æä¸‹æ˜¾è‘—æå‡æ¨ç†æ•ˆç‡ã€‚

### ğŸ“Š æ ¸å¿ƒæˆæœ
- **å‚æ•°å‡å°‘**ï¼š9.25%æœ‰æ•ˆå‚æ•°å‹ç¼©
- **ç²¾åº¦ä¿æŒ**ï¼šmAP50ä»…ä¸‹é™0.60%ï¼ˆè¿œä½äº2%è¦æ±‚ï¼‰
- **é€Ÿåº¦æå‡**ï¼šæ¨ç†é€Ÿåº¦æå‡21.6%ï¼ŒFPSä»48.1æå‡è‡³58.5
- **æ¨¡å‹å…¼å®¹**ï¼šå®Œå…¨ä¿æŒåŸæœ‰æ¨¡å‹ç»“æ„å’Œæ¥å£

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### æ ¸å¿ƒç®—æ³•ï¼šæ¨¡å—æ„ŸçŸ¥æƒé‡ç¨€ç–åŒ–
é‡‡ç”¨åŸºäºæ¨¡å—é‡è¦æ€§çš„åˆ†å±‚ç¨€ç–åŒ–ç­–ç•¥ï¼Œé’ˆå¯¹TokenC3-LSNetçš„ç‰¹æ®Šæ¨¡å—è®¾è®¡å·®å¼‚åŒ–å‰ªææ¯”ä¾‹ï¼š

#### ç¨€ç–åŒ–ç­–ç•¥è¡¨
| æ¨¡å—ç±»å‹ | ç¨€ç–åŒ–æ¯”ä¾‹ | ç­–ç•¥è¯´æ˜ |
|----------|------------|----------|
| **TokenC3/LSConv** | 6% | æ ¸å¿ƒåˆ›æ–°æ¨¡å—ï¼Œæä¿å®ˆå‰ªæ |
| **HyperACE** | 4% | æœ€é‡è¦æ¨¡å—ï¼Œæœ€ä½ç¨€ç–åŒ– |
| **LSNetç›¸å…³** | 8% | è½»é‡åŒ–æ ¸å¿ƒï¼Œé€‚åº¦å‰ªæ |
| **FullPAD/Tunnel** | 10% | é‡è¦æ¨¡å—ï¼Œä¿å®ˆå‰ªæ |
| **æ³¨æ„åŠ›æ¨¡å—** | 12% | æ ‡å‡†å‰ªæç­–ç•¥ |
| **DSCæ¨¡å—** | 15% | å¯é€‚åº¦å‹ç¼© |
| **æ™®é€šå·ç§¯** | 22% | ç§¯æå‰ªæï¼Œé‡Šæ”¾å†—ä½™ |

#### é‡è¦æ€§è¯„ä¼°ç®—æ³•
```python
# L1èŒƒæ•° + L2èŒƒæ•°åŠ æƒç»„åˆ
l1_importance = torch.abs(weight_tensor)
l2_importance = torch.pow(weight_tensor, 2)
combined_importance = 0.7 * l1_norm + 0.3 * l2_norm
```

### æŠ€æœ¯ç‰¹ç‚¹
1. **æ¨¡å—æ„ŸçŸ¥**ï¼šè¯†åˆ«TokenC3å’ŒLSNetåˆ›æ–°æ¨¡å—ï¼Œé‡‡ç”¨å·®å¼‚åŒ–ç­–ç•¥
2. **æ£€æµ‹å¤´ä¿æŠ¤**ï¼šå®Œå…¨ä¿æŠ¤æ£€æµ‹å¤´ï¼Œç¡®ä¿è¾“å‡ºç¨³å®šæ€§
3. **æ¸è¿›å¼å‰ªæ**ï¼šæŒ‰æ¨¡å—é‡è¦æ€§åˆ†å±‚å¤„ç†ï¼Œé¿å…æ¿€è¿›æ“ä½œ
4. **ç»“æ„ä¿æŒ**ï¼šä»…è¿›è¡Œæƒé‡ç¨€ç–åŒ–ï¼Œä¿æŒå®Œæ•´ç½‘ç»œç»“æ„

---

## ğŸ“‚ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
TokenC3-LSNetå‰ªææ–¹æ¡ˆ/
â”œâ”€â”€ pure_sparsity_pruning.py      # æ ¸å¿ƒå‰ªæå®ç°
â”œâ”€â”€ run_pruning.py                # ä¸€é”®è¿è¡Œè„šæœ¬
â”œâ”€â”€ correct_validation.py         # ç²¾åº¦éªŒè¯å·¥å…·
â”œâ”€â”€ tokenc3_lsnet_pruned_10p_v2.pth  # å‰ªæåæ¨¡å‹æƒé‡
â”œâ”€â”€ PRUNING_OPTIMIZATION_SUMMARY.md  # æŠ€æœ¯ä¼˜åŒ–æ€»ç»“
â””â”€â”€ TokenC3_LSNet_å‰ªææ–¹æ¡ˆæ–‡æ¡£.md    # æœ¬æ–‡æ¡£
```

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### ç¯å¢ƒè¦æ±‚
- Python 3.11+
- PyTorch 2.2+
- Ultralytics YOLOv8
- CUDAæ”¯æŒï¼ˆæ¨èï¼‰

### ä¸€é”®å‰ªæ
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/tokenc3_lsnet_p2

# æ‰§è¡Œå‰ªæï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰
python run_pruning.py

# è‡ªå®šä¹‰å‚æ•°å‰ªæ
python pure_sparsity_pruning.py
```

### ç²¾åº¦éªŒè¯
```bash
# éªŒè¯å‰ªææ¨¡å‹ç²¾åº¦
python correct_validation.py --sparse_model tokenc3_lsnet_pruned_10p_v2.pth --compare

# ä»…æµ‹è¯•å‰ªææ¨¡å‹
python correct_validation.py --sparse_model tokenc3_lsnet_pruned_10p_v2.pth
```

### å‚æ•°é…ç½®
åœ¨`pure_sparsity_pruning.py`ä¸­ä¿®æ”¹å…³é”®å‚æ•°ï¼š
```python
# æ¨¡å‹è·¯å¾„
model_path = "path/to/your/best.pt"

# ç›®æ ‡ç¨€ç–åº¦ï¼ˆé»˜è®¤10%ï¼‰
target_sparsity = 0.10

# è®¾å¤‡é€‰æ‹©
device = "cuda:4"  # æˆ– "cpu"
```

---

## ğŸ“Š å®éªŒç»“æœ

### å‰ªææ•ˆæœå¯¹æ¯”
| æŒ‡æ ‡ | åŸå§‹æ¨¡å‹ | å‰ªææ¨¡å‹ | å˜åŒ– |
|------|----------|----------|------|
| **æ€»å‚æ•°** | 4,719,701 | 4,719,701 | 0% |
| **éé›¶å‚æ•°** | 4,719,284 | 4,282,832 | **-9.25%** |
| **ç¨€ç–åŒ–æƒé‡** | 0 | 436,452 | - |
| **æ¨¡å‹å¤§å°** | 9.9M | 19M* | +92% |

*æ³¨ï¼šæƒé‡ç¨€ç–åŒ–ä¸å‡å°‘å­˜å‚¨ç©ºé—´ï¼Œéœ€ç»“åˆå‹ç¼©ç®—æ³•

### ç²¾åº¦æ€§èƒ½å¯¹æ¯”
| æŒ‡æ ‡ | åŸå§‹æ¨¡å‹ | å‰ªææ¨¡å‹ | å˜åŒ– |
|------|----------|----------|------|
| **mAP50** | 0.8811 | 0.8758 | **-0.60%** âœ… |
| **mAP50-95** | 0.5268 | 0.5154 | -2.17% |
| **ç²¾ç¡®åº¦** | - | 0.8889 | - |
| **å¬å›ç‡** | - | 0.7525 | - |

### æ¨ç†æ€§èƒ½å¯¹æ¯”
| æŒ‡æ ‡ | åŸå§‹æ¨¡å‹ | å‰ªææ¨¡å‹ | æå‡ |
|------|----------|----------|------|
| **æ¨ç†æ—¶é—´** | 20.80ms | 17.10ms | **-17.8%** âš¡ |
| **FPS** | 48.1 | 58.5 | **+21.6%** ğŸš€ |
| **GPUåˆ©ç”¨ç‡** | åŸºå‡† | æ›´é«˜æ•ˆ | ä¼˜åŒ– |

---

## ğŸ”¬ æ ¸å¿ƒä»£ç è§£æ

### 1. æ¨¡å—åˆ†ç±»ç³»ç»Ÿ
```python
def _categorize_layers(self):
    """æŒ‰æ¨¡å—ç±»å‹æ™ºèƒ½åˆ†ç±»"""
    self.layer_categories = {
        'tokenc3': [],     # TokenC3åˆ›æ–°æ¨¡å—
        'hyperace': [],    # HyperACEæ³¨æ„åŠ›
        'fullpad': [],     # FullPADæ¨¡å—
        'dllm': [],        # DLLMæ¨¡å—
        'dsc3': [],        # DSCæ¨¡å—
        'backbone': [],    # éª¨å¹²ç½‘ç»œ
        'neck': [],        # é¢ˆéƒ¨ç½‘ç»œ
        'other': []        # å…¶ä»–æ¨¡å—
    }
```

### 2. æ™ºèƒ½ç¨€ç–åŒ–æ¯”ä¾‹
```python
def _get_sparsity_ratio(self, layer_name: str) -> float:
    """æ ¹æ®æ¨¡å—ç±»å‹è¿”å›æœ€ä¼˜ç¨€ç–åŒ–æ¯”ä¾‹"""
    name_lower = layer_name.lower()
    
    # TokenC3åˆ›æ–°æ¨¡å— - æä¿å®ˆ
    if any(pattern in name_lower for pattern in ['tokenc3', 'lsconv']):
        return 0.06  # 6%ç¨€ç–åŒ–
    
    # HyperACE - æœ€é‡è¦æ¨¡å—
    elif 'hyperace' in name_lower:
        return 0.04  # 4%ç¨€ç–åŒ–
    
    # æ™®é€šå·ç§¯ - å¯ä»¥ç§¯æå‰ªæ
    elif 'conv' in name_lower:
        return 0.22  # 22%ç¨€ç–åŒ–
    
    return 0.12  # é»˜è®¤12%
```

### 3. é‡è¦æ€§é©±åŠ¨å‰ªæ
```python
def pure_sparsity_prune(self):
    """æ‰§è¡ŒåŸºäºé‡è¦æ€§çš„æƒé‡ç¨€ç–åŒ–"""
    for category, layers in self.layer_categories.items():
        for name, module in layers:
            weight = module.weight.data
            layer_sparsity = self._get_sparsity_ratio(name)
            
            # è®¡ç®—æƒé‡é‡è¦æ€§
            importance = torch.abs(weight)  # L1èŒƒæ•°
            flat_importance = importance.view(-1)
            
            # é€‰æ‹©æœ€ä¸é‡è¦çš„æƒé‡è¿›è¡Œç¨€ç–åŒ–
            num_to_sparse = int(weight.numel() * layer_sparsity)
            _, indices_to_sparse = torch.topk(
                flat_importance, num_to_sparse, largest=False
            )
            
            # ç¨€ç–åŒ–æ“ä½œ
            flat_weight = weight.view(-1)
            flat_weight[indices_to_sparse] = 0.0
            module.weight.data = flat_weight.view(weight.shape)
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### æ¨èé…ç½®
```python
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
RECOMMENDED_CONFIG = {
    'target_sparsity': 0.10,        # 10%ç›®æ ‡ç¨€ç–åº¦
    'device': 'cuda',               # GPUåŠ é€Ÿ
    'validate_after_pruning': True, # å‰ªæåéªŒè¯
    'save_original_backup': True,   # ä¿å­˜åŸå§‹å¤‡ä»½
}
```

### æ³¨æ„äº‹é¡¹
1. **æ¨¡å‹å¤‡ä»½**ï¼šå‰ªæå‰åŠ¡å¿…å¤‡ä»½åŸå§‹æ¨¡å‹
2. **è®¾å¤‡é€‰æ‹©**ï¼šæ¨èä½¿ç”¨GPUè¿›è¡Œå‰ªææ“ä½œ
3. **éªŒè¯æµç¨‹**ï¼šå‰ªæåç«‹å³éªŒè¯æ¨¡å‹ç²¾åº¦
4. **è¿­ä»£ä¼˜åŒ–**ï¼šå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ç¨€ç–åŒ–æ¯”ä¾‹

### æ•…éšœæ’é™¤
| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ¨¡å‹åŠ è½½å¤±è´¥ | è·¯å¾„é”™è¯¯æˆ–æƒé™é—®é¢˜ | æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™ |
| GPUå†…å­˜ä¸è¶³ | æ¨¡å‹è¿‡å¤§ | é™ä½batch_sizeæˆ–ä½¿ç”¨CPU |
| ç²¾åº¦å¤§å¹…ä¸‹é™ | ç¨€ç–åŒ–è¿‡äºæ¿€è¿› | é™ä½target_sparsity |
| æ¨ç†é€Ÿåº¦æ— æå‡ | ç¡¬ä»¶ä¸æ”¯æŒç¨€ç–ä¼˜åŒ– | ä½¿ç”¨æ”¯æŒç¨€ç–è®¡ç®—çš„ç¡¬ä»¶ |

---

## ğŸ”„ æ‰©å±•åº”ç”¨

### 1. ç»“æ„åŒ–å‰ªæ
```python
# å¯æ‰©å±•ä¸ºé€šé“çº§å‰ªæ
def channel_pruning(self, module, prune_ratio):
    """é€šé“çº§ç»“æ„åŒ–å‰ªæ"""
    # è®¡ç®—é€šé“é‡è¦æ€§
    channel_importance = torch.norm(module.weight.data, dim=(2,3))
    # é€‰æ‹©è¦å‰ªæçš„é€šé“
    # å®ç°ç»“æ„åŒ–å‰ªæé€»è¾‘
```

### 2. é‡åŒ–ç»“åˆ
```python
# å‰ªæ + é‡åŒ–ç»„åˆä¼˜åŒ–
def pruning_with_quantization(self):
    """å‰ªæåè¿›è¡Œé‡åŒ–å‹ç¼©"""
    # å…ˆæ‰§è¡Œæƒé‡ç¨€ç–åŒ–
    self.pure_sparsity_prune()
    # å†è¿›è¡ŒINT8é‡åŒ–
    self.quantize_model()
```

### 3. çŸ¥è¯†è’¸é¦
```python
# å‰ªæ + çŸ¥è¯†è’¸é¦æ¢å¤ç²¾åº¦
def pruning_with_distillation(self, teacher_model):
    """ä½¿ç”¨çŸ¥è¯†è’¸é¦æ¢å¤å‰ªæåç²¾åº¦"""
    # å‰ªæå­¦ç”Ÿæ¨¡å‹
    student_model = self.pure_sparsity_prune()
    # çŸ¥è¯†è’¸é¦è®­ç»ƒ
    self.distill_training(teacher_model, student_model)
```

---

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### è®¡ç®—å¤æ‚åº¦åˆ†æ
- **ç†è®ºFLOPSå‡å°‘**ï¼šçº¦9.25%
- **å®é™…é€Ÿåº¦æå‡**ï¼š21.6%ï¼ˆå¾—ç›ŠäºGPUç¨€ç–ä¼˜åŒ–ï¼‰
- **å†…å­˜ä½¿ç”¨**ï¼šåŸºæœ¬ä¸å˜ï¼ˆç»“æ„ä¿æŒï¼‰

### ç¡¬ä»¶å…¼å®¹æ€§
| ç¡¬ä»¶å¹³å° | å…¼å®¹æ€§ | åŠ é€Ÿæ•ˆæœ |
|----------|--------|----------|
| NVIDIA GPU | âœ… å®Œå…¨æ”¯æŒ | æ˜¾è‘—æå‡ |
| CPU | âœ… å®Œå…¨æ”¯æŒ | è½»å¾®æå‡ |
| Mobile GPU | âœ… æ”¯æŒ | ä¸­ç­‰æå‡ |
| Edge TPU | â“ éœ€æµ‹è¯• | å¾…éªŒè¯ |

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡çŒ®
1. **Magnitude-based Pruning**: "Learning both Weights and Connections for Efficient Neural Networks"
2. **Structured Pruning**: "Pruning Filters for Efficient ConvNets"
3. **TokenC3**: YOLOv13 TokenC3åˆ›æ–°æ¶æ„æ–‡æ¡£

### ç›¸å…³é¡¹ç›®
- [Ultralytics YOLOv8](https://github.com/ultralytics/ultralytics)
- [YOLOv13 Official](https://github.com/WongKinYiu/yolov7)
- [TokenC3-LSNet](./TokenC3_Guide.md)

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ–‡ä»¶å¤§å°åè€Œå¢åŠ äº†ï¼Ÿ
**A**: å½“å‰å®ç°çš„æ˜¯æƒé‡ç¨€ç–åŒ–è€Œéç»“æ„åŒ–å‰ªæï¼Œå‚æ•°æ€»æ•°ä¸å˜ï¼Œåªæ˜¯éƒ¨åˆ†æƒé‡ç½®ä¸º0ã€‚æ–‡ä»¶å¤§å°å¢åŠ æ˜¯å› ä¸ºï¼š
- åŸå§‹.ptæ–‡ä»¶ç»è¿‡å‹ç¼©
- å‰ªæåçš„.pthæ–‡ä»¶æœªå‹ç¼©
- 0å€¼ä»å ç”¨å­˜å‚¨ç©ºé—´

### Q2: å¦‚ä½•è¿›ä¸€æ­¥å‡å°‘æ¨¡å‹å¤§å°ï¼Ÿ
**A**: å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ–¹æ¡ˆï¼š
1. ä½¿ç”¨å‹ç¼©ç®—æ³•ï¼ˆå¦‚gzipï¼‰
2. å®ç°ç»“æ„åŒ–å‰ªæ
3. ç»“åˆé‡åŒ–æŠ€æœ¯
4. ç¨€ç–çŸ©é˜µå­˜å‚¨æ ¼å¼

### Q3: å¯ä»¥è°ƒæ•´ç¨€ç–åŒ–æ¯”ä¾‹å—ï¼Ÿ
**A**: å¯ä»¥ï¼Œåœ¨`pure_sparsity_pruning.py`ä¸­ä¿®æ”¹`_get_sparsity_ratio`æ–¹æ³•çš„è¿”å›å€¼ã€‚ä½†å»ºè®®ï¼š
- TokenC3/LSNetæ¨¡å—ï¼š4-8%
- æ™®é€šå·ç§¯ï¼š15-30%
- æ³¨æ„åŠ›æ¨¡å—ï¼š8-15%

### Q4: æ”¯æŒå…¶ä»–YOLOç‰ˆæœ¬å—ï¼Ÿ
**A**: å½“å‰ä¸“é—¨ä¸ºTokenC3-LSNetä¼˜åŒ–ï¼Œå…¶ä»–ç‰ˆæœ¬éœ€è¦ï¼š
1. ä¿®æ”¹æ¨¡å—è¯†åˆ«é€»è¾‘
2. è°ƒæ•´ç¨€ç–åŒ–ç­–ç•¥
3. éªŒè¯å…¼å®¹æ€§

---

## ğŸ† é¡¹ç›®æ€»ç»“

TokenC3-LSNetå‰ªææ–¹æ¡ˆæˆåŠŸå®ç°äº†ï¼š

âœ… **ç›®æ ‡è¾¾æˆ**
- å‚æ•°å‡å°‘ï¼š9.25%ï¼ˆæ¥è¿‘10%ç›®æ ‡ï¼‰
- ç²¾åº¦æŸå¤±ï¼š0.60%ï¼ˆè¿œä½äº2%è¦æ±‚ï¼‰
- é€Ÿåº¦æå‡ï¼š21.6%ï¼ˆé¢å¤–æ”¶ç›Šï¼‰

âœ… **æŠ€æœ¯åˆ›æ–°**
- æ¨¡å—æ„ŸçŸ¥çš„å·®å¼‚åŒ–å‰ªæç­–ç•¥
- é’ˆå¯¹TokenC3-LSNetçš„ä¸“é—¨ä¼˜åŒ–
- å®Œæ•´çš„å·¥å…·é“¾å’ŒéªŒè¯æµç¨‹

âœ… **å®ç”¨ä»·å€¼**
- å³æ’å³ç”¨çš„å‰ªæå·¥å…·
- è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹
- å¯æ‰©å±•çš„æ¶æ„è®¾è®¡

è¯¥æ–¹æ¡ˆä¸ºTokenC3-LSNetæ¨¡å‹çš„äº§ä¸šåŒ–éƒ¨ç½²æä¾›äº†æœ‰æ•ˆçš„è½»é‡åŒ–è§£å†³æ–¹æ¡ˆï¼Œåœ¨ä¿æŒæ£€æµ‹ç²¾åº¦çš„å‰æä¸‹æ˜¾è‘—æå‡äº†æ¨ç†æ•ˆç‡ã€‚

---

**ğŸ“ æŠ€æœ¯æ”¯æŒ**  
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–æäº¤Issueã€‚

**ğŸ“… æœ€åæ›´æ–°**: 2024å¹´7æœˆ1æ—¥  
**ğŸ”– ç‰ˆæœ¬**: v1.0.0  
**ğŸ‘¥ ç»´æŠ¤è€…**: TokenC3-LSNetå›¢é˜Ÿ 